---
name: code-edit-workflow
description: |
  トリガー: 1ファイルでも15行以上の編集 / 2ファイル以上の編集 / ファイル削除 / ユーザーが「計画して」と依頼
  コード編集・ファイル操作を行う前の確認フロー。命令の理解から編集実行までの手順
---

# コード編集ワークフロー

コード編集・ファイル操作を行う前に、必ず次の手順を踏む。

## 1. 命令の理解

ユーザーからの命令を要約し、以下を箇条書きで整理してユーザーに提示する：
- 何を達成したいのか（目的）
- どの範囲に影響しそうか（スコープ）

```
例:
目的: ログイン機能にバリデーションを追加
スコープ: auth/ ディレクトリ内のファイル
```

## 2. 変更候補ファイルの洗い出し

目的達成に必要だと考えるファイルを列挙し、以下を説明する：
- ファイルパス
- 簡単な役割

その後、**どのファイルを変更対象とするかユーザーに確認**する。

```
例:
変更候補:
- src/auth/login.py - ログイン処理のメイン
- src/auth/validators.py - バリデーション関数
- tests/test_login.py - テストケース

これらのファイルを変更してよいですか？
```

## 3. 実行計画の提示

「どのファイルを、どの順番で、どう変えるか」を 3〜7 ステップ程度の実行計画として示す。

破壊的な変更がある場合は特に明示する：
- ファイルの削除
- 大規模なリファクタリング
- 既存APIの変更

```
例:
実行計画:
1. validators.py にメールアドレス検証関数を追加
2. login.py でバリデーション関数を呼び出し
3. test_login.py にテストケースを追加
4. 動作確認
```

## 4. ユーザーからの確認

- ユーザーの `OK` または修正指示を得るまでは **コードを編集しない**
- 不明点がある場合は「推測で進める」のではなく、必ず質問する

```
例:
「メールアドレスの形式チェックのみでよいですか？
 それともドメインの存在確認も必要ですか？」
```

## 5. 編集の実行と報告

合意した計画に基づいて編集を行う。

編集後、以下を報告する：
- どのファイルを変更したか
- どのように変更したか（`git diff` の要約）
- 必要なテストや簡易動作確認の結果

```
例:
変更完了:
- validators.py: validate_email() 関数を追加（15行）
- login.py: バリデーション呼び出しを追加（3行）
- test_login.py: テストケース3件追加

テスト結果: 全件パス
```

## 例外: 即座に編集してよいケース

以下の場合は確認を省略してよい：
- 明らかなtypo修正（1-2行）
- ユーザーが「すぐやって」と明示した場合
- 事前に合意した計画内の作業

ただし、編集後の報告は必ず行う。
